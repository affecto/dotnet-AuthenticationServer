install:
- cmd: Scripts\patch-version.cmd
- ps: if ($env:APPVEYOR_REPO_BRANCH -eq "master" -Or $env:APPVEYOR_REPO_BRANCH -eq "development" -Or $env:APPVEYOR_REPO_BRANCH.StartsWith("release") -Or $env:APPVEYOR_REPO_BRANCH.StartsWith("hotfix")) { $env:RunOctoPack="true" }

assembly_info:
  patch: true
  file: 'Source\AuthenticationServer\Properties\AssemblyInfo.cs'
  assembly_version: $(CUSTOM_VERSION)
  assembly_file_version: $(CUSTOM_VERSION)
  assembly_informational_version: $(CUSTOM_INFORMATIONAL_VERSION)

before_build:
- cmd: nuget restore "Source\AuthenticationServer.sln"

build:
  verbosity: minimal

configuration: Release

after_build:
- cmd: nuget pack "Source\AuthenticationServer.Claims\AuthenticationServer.Claims.csproj" -Properties "Configuration=Release;Platform=AnyCPU" -Symbols -IncludeReferencedProjects
- cmd: nuget pack "Source\AuthenticationServer.Plugins.Infrastructure\AuthenticationServer.Plugins.Infrastructure.csproj" -Properties "Configuration=Release;Platform=AnyCPU" -Symbols -IncludeReferencedProjects
pull_requests:
  do_not_increment_build_number: true

nuget:
  disable_publish_on_pr: true

artifacts:
  - path: 'Source\AuthenticationServer\obj\octopacked\AuthenticationServer.*.nupkg'
    name: Authentication Server OctoPack
  - path: 'Source\AuthenticationServer.IdentityManagement\obj\octopacked\AuthenticationServer.IdentityManagement.*.nupkg'
    name: Authentication Server Identity Management Plugin OctoPack
  - path: 'Affecto.AuthenticationServer.Claims.*.nupkg'
  - path: 'Affecto.AuthenticationServer.Plugins.Infrastructure.*.nupkg'

deploy:
- provider: NuGet
  artifact: /Affecto\.AuthenticationServer\.Claims\..*\.nupkg/
  api_key:
    secure: ySttUuKXaqz/qn7dZRtJJs7H8wTDgT8Wgi55QFGZjmVE2XL14T2puaPiBcNMZC1l
  on:
    appveyor_repo_tag: true
- provider: NuGet
  artifact: /Affecto\.AuthenticationServer\.Plugins\.Infrastructure\..*\.nupkg/
  api_key:
    secure: ySttUuKXaqz/qn7dZRtJJs7H8wTDgT8Wgi55QFGZjmVE2XL14T2puaPiBcNMZC1l
  on:
    appveyor_repo_tag: true